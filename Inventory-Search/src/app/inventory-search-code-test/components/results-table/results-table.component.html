<!--components/results-table/results-table.component.html-->

<!-- Simple inline error display for table actions -->
<div class="error" *ngIf="errorMessage">{{ errorMessage }}</div>
<div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>
          <mat-icon class="icon" *ngIf="expanded && (expanded | keyvalue).length > 0" (click)="collapseAll()" matTooltip="Collapse all rows">unfold_less</mat-icon>
        </th>
        <th *ngFor="let h of headers" (click)="onHeaderClick(h.field)" class="sortable">
          {{ h.label }}
        </th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let item of items">
        <tr>
          <td>
            <button mat-icon-button (click)="toggleExpand(item)" aria-label="expand row" class="expand-btn" [class.expanded]="expanded[item.partNumber]" matTooltip="{{ expanded[item.partNumber] ? 'Collapse details' : 'Expand details' }}">
              <mat-icon>{{ expanded[item.partNumber] ? 'expand_more' : 'chevron_right' }}</mat-icon>
            </button>
          </td>
          <td>{{ item.partNumber }}</td>
          <td>{{ item.supplierSku }}</td>
          <td>{{ item.description }}</td>
          <td>{{ item.branch }}</td>
          <td>{{ item.availableQty }}</td>
          <td>{{ item.uom }}</td>
          <td>{{ item.leadTimeDays ?? '—' }}</td>
          <td>{{ (item.lastPurchaseDate | date:'MMM d, y - h:mm a') || '—' }}</td>
          <td>
            <mat-progress-spinner *ngIf="peakLoading[item.partNumber]" diameter="20" mode="indeterminate"></mat-progress-spinner>
            <button mat-stroked-button *ngIf="!peakLoading[item.partNumber]" (click)="onPeakButton(item)" aria-label="load peak availability">
              Peak Availability
            </button>
          </td>
        </tr>
        <tr *ngIf="expanded[item.partNumber]" class="expand-row">
          <td colspan="10">
            <div class="expanded-content">
              <div class="lots-section" *ngIf="item.lots && item.lots.length > 0; else noLots">
                <strong>Lots:</strong>
                <ul *ngFor="let lot of item.lots" class="lot-item">
                  <li>
                    Lot {{ lot.lotNumber }} — Qty {{ lot.qty }} — Exp {{ (lot.expirationDate | date:'MMM d, y - h:mm a') || 'N/A' }}
                  </li>
                </ul>
              </div>
              <ng-template #noLots>
                <div class="no-lots">No lot details available.</div>
              </ng-template>

              <hr />

              <div class="peak-section" *ngIf="peakByPart[item.partNumber]; else noPeak">
                <div><strong>Part:</strong> {{ peakByPart[item.partNumber]?.partNumber || item.partNumber }}</div>
                <div><strong>Total available:</strong> {{ peakByPart[item.partNumber]?.totalAvailable ?? 0 }}</div>
                <div><strong>By branch:</strong></div>
                <ul *ngFor="let b of peakByPart[item.partNumber]?.branches" class="branch-qty">
                  <li>{{ b.branch }}: {{ b.qty }}</li>
                </ul>
              </div>

              <ng-template #noPeak>
                <div class="no-peak">No peak availability loaded yet. Use the "Peak Availability" button to load data.</div>
              </ng-template>
            </div>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>
</div>

<mat-paginator [length]="total" [pageIndex]="pageIndex" [pageSize]="pageSize" [showFirstLastButtons]="true" (page)="handlePageEvent($event)" aria-label="Select page"></mat-paginator>